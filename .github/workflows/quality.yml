# SPDX-License-Identifier: AGPL-3.0-or-later
name: Code Quality
on: [push, pull_request]

permissions: read-all

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Check file permissions
        run: |
          find . -type f -perm /111 -name "*.sh" | head -10 || true

      - name: Check for secrets
        run: |
          # Simple secrets check without external action dependency
          echo "=== Checking for potential secrets ==="
          SECRETS=$(grep -rEi '(api_key|apikey|secret_key|password)\s*[=:]\s*["\x27][A-Za-z0-9+/=]{20,}' \
            --include="*.py" --include="*.js" --include="*.ts" --include="*.go" --include="*.rs" --include="*.env" \
            . 2>/dev/null | grep -v 'example\|sample\|test\|mock\|placeholder' | head -3 || true)
          if [ -n "$SECRETS" ]; then
            echo "::warning::Potential secrets detected - please review"
            echo "$SECRETS"
          else
            echo "No obvious secrets detected"
          fi
        continue-on-error: true

      - name: Check TODO/FIXME
        run: |
          echo "=== TODOs ==="
          grep -rn "TODO\|FIXME\|HACK\|XXX" --include="*.rs" --include="*.res" --include="*.py" --include="*.ex" . | head -20 || echo "None found"

      - name: Check for large files
        run: |
          find . -type f -size +1M -not -path "./.git/*" | head -10 || echo "No large files"

      - name: EditorConfig check
        run: |
          if [ -f ".editorconfig" ]; then
            echo "EditorConfig found"
          else
            echo "No .editorconfig file"
          fi
        continue-on-error: true

  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Check documentation
        run: |
          MISSING=""
          [ ! -f "README.md" ] && [ ! -f "README.adoc" ] && MISSING="$MISSING README"
          [ ! -f "LICENSE" ] && [ ! -f "LICENSE.txt" ] && [ ! -f "LICENSE.md" ] && MISSING="$MISSING LICENSE"
          [ ! -f "CONTRIBUTING.md" ] && [ ! -f "CONTRIBUTING.adoc" ] && MISSING="$MISSING CONTRIBUTING"
          
          if [ -n "$MISSING" ]; then
            echo "::warning::Missing docs:$MISSING"
          else
            echo "âœ… Core documentation present"
          fi
